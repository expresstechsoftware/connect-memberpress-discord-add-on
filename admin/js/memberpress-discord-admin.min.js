!function(e){"use strict";e(document).ready(function(){if(etsMemberpressParams.is_admin){function r(e){e.draggable({revert:"invalid",helper:"clone",start:function(e,r){r.helper.css({width:"45%"})}})}function a(r,a){var s=a.draggable;s.data("level_id")&&e(a.draggable).remove().hide(),e(this).append(s),e('*[data-drop-role_id="'+s.data("role_id")+'"]').droppable({drop:t,hoverClass:"hoverActive"}),e('*[data-drop-role_id="'+s.data("role_id")+'"]').attr("data-drop-role_id","");var o=JSON.parse(localStorage.getItem("MemberPressMapArray"))||[];e.each(o,function(e,r){if(r){var a=r.split(",");a[0]=="level_id_"+s.data("level_id")&&a[1]==s.data("role_id")&&delete o[e]}});var i="{";e.each(o,function(e,r){if(r){var a=r.split(",");(a[0]!="level_id_"+s.data("level_id")||a[1]!=s.data("role_id"))&&(i=i+'"'+a[0]+'":"'+a[1]+'",')}}),localStorage.setItem("MemberPressMapArray",JSON.stringify(o)),","==i.slice(-1)&&(i=i.slice(0,-1));var d=i+"}";e("#maaping_json_val").html(d),localStorage.setItem("MemberPressMappingjson",d),s.css({width:"100%",left:"0",top:"0","margin-bottom":"10px"})}function t(a,s){s.draggable;var o=e(s.helper).clone();if(e(this).find(".makeMeDraggable").length>=1)return!1;if(e('*[data-drop-role_id="'+o.data("role_id")+'"]').droppable({drop:t,hoverClass:"hoverActive"}),e('*[data-drop-role_id="'+o.data("role_id")+'"]').attr("data-drop-role_id",""),e(this).data("drop-role_id")!=o.data("role_id")){var i=JSON.parse(localStorage.getItem("MemberPressMapArray"))||[];e(this).attr("data-drop-role_id",o.data("role_id")),o.attr("data-level_id",e(this).data("level_id")),e.each(i,function(r,a){a&&a.split(",")[0]=="level_id_"+e(this).data("level_id")&&delete i[r]});var d="level_id_"+e(this).data("level_id");i.push(d+","+o.data("role_id"));var n="{";e.each(i,function(r,a){if(a){var t=a.split(",");(t[0]=="level_id_"+e(this).data("level_id")||t[1]!=o.data("role_id")&&t[0]!="level_id_"+e(this).data("level_id")||t[1]==o.data("role_id"))&&(n=n+'"'+t[0]+'":"'+t[1]+'",')}}),localStorage.setItem("MemberPressMapArray",JSON.stringify(i)),","==n.slice(-1)&&(n=n.slice(0,-1));var l=n+"}";localStorage.setItem("MemberPressMappingjson",l),e("#maaping_json_val").html(l)}e(this).append(o),e(this).find("span").css({order:"2"}),jQuery(this).find(".makeMeDraggable").length>=1&&e(this).droppable("destroy"),r(e(".makeMeDraggable")),o.css({width:"100%","margin-bottom":"0px",left:"0",position:"unset",order:"1"})}-1==window.location.href.indexOf("mepr_")&&"mepr_settings"==jQuery("#skeletabsTab1").data("identity")&&jQuery("#skeletabsTab1").trigger("click"),e.ajax({type:"POST",dataType:"JSON",url:etsMemberpressParams.admin_ajax,data:{action:"memberpress_load_discord_roles",ets_memberpress_discord_nonce:etsMemberpressParams.ets_memberpress_discord_nonce},beforeSend:function(){e(".discord-roles .spinner").addClass("is-active"),e(".initialtab.spinner").addClass("is-active")},success:function(a){if(null!=a&&a.hasOwnProperty("code")&&50001==a.code&&"Missing Access"==a.message)e(".btn-connect-to-bot").show();else if(10004===a.code&&"Unknown Guild"==a.message)e(".btn-connect-to-bot").show().after("<p><b>The server ID is wrong or you did not connect the Bot.</b></p>");else if(0===a.code&&"401: Unauthorized"==a.message)e("#connect-discord-bot").show().html("Error: Unauthorized - The Bot Token is wrong").addClass("error-bk");else if(null==a||"401: Unauthorized"==a.message||a.hasOwnProperty("code")||0==a)e("#connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk");else{e('.ets-tabs button[data-identity="level-mapping"]').length&&e('.ets-tabs button[data-identity="level-mapping"]').show(),e("#connect-discord-bot").show().html("Bot Connected "+etsMemberpressParams.discord_icon).addClass("not-active");var t=localStorage.getItem("activeTab");0==e('.ets-tabs button[data-identity="level-mapping"]').length&&"level-mapping"==t&&e('.ets-tabs button[data-identity="mepr_settings"]').trigger("click"),e.each(a,function(a,t){var s=!1;t.hasOwnProperty("tags")&&t.tags.hasOwnProperty("bot_id")&&(s=!0),"previous_mapping"!=a&&!1==s&&"@everyone"!=t.name&&(e(".discord-roles").append('<div class="makeMeDraggable" style="background-color:#'+t.color.toString(16)+'" data-role_id="'+t.id+'" >'+t.name+"</div>"),e("#defaultRole").append('<option value="'+t.id+'" >'+t.name+"</option>"),r(e(".makeMeDraggable")))});var s=e("#selected_default_role").val();if(s&&e("#defaultRole option[value="+s+"]").prop("selected",!0),a.previous_mapping)var o=a.previous_mapping;else var o=localStorage.getItem("MemberPressMappingjson");e("#maaping_json_val").html(o),e.each(JSON.parse(o),function(a,t){var s=a.split("id_"),o=e('*[data-role_id="'+t+'"]').clone();o.length>1&&o.slice(1).hide(),0==jQuery('*[data-level_id="'+s[1]+'"]').find('*[data-role_id="'+t+'"]').length&&e('*[data-level_id="'+s[1]+'"]').append(o).attr("data-drop-role_id",t).find("span").css({order:"2"}),e('*[data-level_id="'+s[1]+'"]').find(".makeMeDraggable").length>=1&&e('*[data-level_id="'+s[1]+'"]').droppable("destroy"),o.css({width:"100%",left:"0",top:"0","margin-bottom":"0px",order:"1"}).attr("data-level_id",s[1]),r(o)})}},error:function(r){e("#connect-discord-bot").show().html("Error: Please check all details are correct").addClass("error-bk"),console.error(r)},complete:function(){e(".discord-roles .spinner").removeClass("is-active").css({float:"right"}),e("#skeletabsTab1 .spinner").removeClass("is-active").css({float:"right",display:"none"})}}),e("#clrbtn").click(function(r){r.preventDefault(),e.ajax({url:etsMemberpressParams.admin_ajax,type:"POST",data:{action:"memberpress_discord_clear_logs",ets_memberpress_discord_nonce:etsMemberpressParams.ets_memberpress_discord_nonce},beforeSend:function(){e(".clr-log.spinner").addClass("is-active").show()},success:function(r){r.error?alert(r.error.msg):e(".error-log").html("Clear logs Sucesssfully !")},error:function(e){console.error(e)},complete:function(){e(".clr-log.spinner").removeClass("is-active").hide()}})}),e(".ets-memberpress-run-api").on("click",function(r){r.preventDefault();var a=e(this).data("uid");e.ajax({type:"POST",dataType:"JSON",url:etsMemberpressParams.admin_ajax,data:{action:"memberpress_discord_member_table_run_api",user_id:a,ets_memberpress_discord_nonce:etsMemberpressParams.ets_memberpress_discord_nonce},beforeSend:function(){e("."+a+".spinner").addClass("is-active").show()},success:function(r){1==r.status&&e("."+a+".ets-save-success").show()},error:function(e){console.error(e)},complete:function(){e("."+a+".spinner").removeClass("is-active").hide()}})}),e("#MemberPressRevertMapping").click(function(){localStorage.removeItem("MemberPressMapArray"),localStorage.removeItem("MemberPressMappingjson")}),e(function r(){e(".makeMeDroppable").droppable({drop:t,hoverClass:"hoverActive"}),e(".discord-roles-col").droppable({drop:a,hoverClass:"hoverActive"})})}e("#ets_memberpress_btn_color").wpColorPicker(),e("#ets_memberpress_discord_btn_disconnect_color").wpColorPicker(),e(" .ets-memberpress-discord-review-notice > button.notice-dismiss").on("click",function(){e.ajax({type:"POST",dataType:"JSON",url:etsMemberpressParams.admin_ajax,data:{action:"ets_memberpress_discord_notice_dismiss",ets_memberpress_discord_nonce:etsMemberpressParams.ets_memberpress_discord_nonce},beforeSend:function(){console.log("sending...")},success:function(e){console.log(e)},error:function(e){console.error(e)},complete:function(){}})}),e("#toggle-search-form").click(function(){e("#search-form-wrapper").toggle()}),e(".serialized-data").on("click",function(){var r=e(this).data("content");e(".ets-log-popup").html("<pre>"+r+"</pre>").fadeIn()}),e(".ets-log-popup").on("click",function(){e(this).fadeOut()})}),e.skeletabs.setDefaults({keyboard:!1})}(jQuery);